async function unzipBlob(n,t){var u=n.slice(0,t),f=n.slice(t),e=new Blob([u]),o=new zip.BlobReader(e),s=new zip.ZipReader(o,{password:(new TextDecoder).decode(new Uint8Array(f))}),i=await s.getEntries(),r;if(i&&i.length){const n=new zip.TextWriter;return r=await i[0].getData(n)}return null}async function createChart(n){var t=new ZipChart(n,n=>{n.forEach(n=>{charts.push(n)})})}function addData(n,t){var i=findChart(n),r;i.options.isLive&&(t=JSON.parse(t),r=t.map(n=>({createdDt:new Date(n.CreationTime).getTime(),fhR1:n.FHR1,fhR2:n.FHR2,toco:n.TOCO,noteId:n.noteId})),i.addPoints(r),i.stockChart.redraw())}function resize(n){let t=n=>{n&&n.generateChart()};(chartResizeTimers[n]?.wait||0)>0||setTimeout(()=>{n?t(findChart(n)):charts.forEach(n=>{t(n)})},400)}function removeChart(n){var t=findChart("chart_"+n);charts=charts.filter(t=>t.chartId=="chart_"+n);delete chartResizeTimers["chart_"+n]}function onclickEvent(){}function concat(...n){for(var i,r={},t=0;t<n.length;t++)for(i in n[t]||{})r[i]=typeof n[t][i]=="object"?concat(r[i],n[t][i]):n[t][i];return r}function printChart(n){createLoading(n.chartId,"Please wait while the CTG is being prepared for printing.");var t=document.createElement("iframe");t.hidden=!0;document.body.appendChild(t);t.onload=()=>{console.log("iframe onload"),t.contentWindow.print(),removeLoading(n.chartId)};t.src="/Print/"+n.options.stripId}function createLoading(n,t){$("#"+n).css({position:"relative"});$(`<div id="loading_${n}" style="position:absolute;inset:0;background-color:transparent;backdrop-filter: blur(5px);display: flex;justify-content: center;align-items: center;" />`).append(`<h4><i class="fa fa-spinner fa-spin me-2" ></i>${t}</h4>`).appendTo("#"+n)}function removeLoading(n){$(`#loading_${n}`).remove()}function changeViewColumns(n){multiview_dotNetObjRef&&multiview_dotNetObjRef.invokeMethodAsync("ChangeViewColumns",n)}function viewSingle(n){multiview_dotNetObjRef&&multiview_dotNetObjRef.invokeMethodAsync("ViewSingle",n)}function RegisterMultiViewDotNetObjectReference(n){multiview_dotNetObjRef=n}function RegisterSingleViewDotNetObjectReference(n){singleview_dotNetObjRef=n}function findChart(n,t){var r=charts.find(t=>t.chartId==n),i;return r?r:t||t==0?charts.find(i=>i.options.stripId==n&&i.sequence==t):(i=charts.filter(t=>t.options.stripId==n),!i.length)?null:i.sort((n,t)=>t.sequence-n.sequence)[0]}var charts=[],chartResizeTimers={},multiview_dotNetObjRef,singleview_dotNetObjRef;class CTGChart{get chartId(){return`chart_${this.options.stripId}_${this.sequence}`}constructor(n,t){this.sequence=n;this.options=t;this.createChart()}createChart(){console.time("chart.createChart()");this.setChartResizeObserver();this.generateChart();console.timeEnd("chart.createChart()")}setChartResizeObserver(){this.width=$("#"+this.chartId).width();var n=chartResizeTimers[this.chartId]={wait:2e3,timer:undefined};const t=new ResizeObserver(t=>{n.wait=1e3,clearInterval(n.timer),n.timer=setInterval(()=>{n.wait-=500,i(t)},500)});t.observe(document.querySelector("#"+this.chartId));let i=t=>{if(!(n.wait>0)){var i=$(t[0].target).width();i>0&&i!=this.width&&(this.width=i,resize(this.chartId));clearInterval(n.timer)}}}addPoints(n,t=true){if(console.time("addPoints"),n.forEach((n,t)=>{var i=n.createdDt;t<=10;n.noteId!=null&&this.note_series.addPoint([i,100,n.noteId],!1);this.series0.addPoint([i,n.fhR1],!1);this.series1.addPoint([i,n.fhR2],!1);this.series2.addPoint([i,n.toco],!1)}),this.options.showLatestValuesLabel){let r=0,u=0,f=0;if(n.length&&t){var i=n[n.length-1];r=~~i.fhR1;u=~~i.fhR2;f=~~i.toco}this.setLabelValues(r,u,f);this.reset_ClearLabelsTimer()}console.timeEnd("addPoints")}setLabelValues(n,t,i){this.fhr1_label.attr({text:n||"--"});this.fhr2_label.attr({text:t||"--"});this.toco_label.attr({text:i||"--"})}reset_ClearLabelsTimer(){clearTimeout(this.clearLabelsTimer);this.clearLabelsTimer=setTimeout(()=>{this.setLabelValues(0,0,0)},5e3)}generateChart(){var{options:e,label_font_size:r,fhrtop:u,tocotop:o,width:i}=this.createOptions(),n=10,t=40,f=10;if(i<1e3&&(n=10,t=40),i<800&&(n=0,t=15),i<600)var n=0,t=10,f=0;i<400&&(n=-5,t=5);i<300&&(n=-5,t=-10);n+=u;t+=u;f+=o;console.time("Highcharts.stockChart");this.stockChart=Highcharts.stockChart(this.chartId,e,i=>{this.options.showLatestValuesLabel&&(this.fhr1_label=i.renderer.label("",i.plotWidth-30,n).css({color:"black",fontSize:r}).attr({r:5,zIndex:6}).add(),this.fhr2_label=i.renderer.label("",i.plotWidth-30,t).css({color:"red",fontSize:r}).attr({r:5,zIndex:6}).add(),this.toco_label=i.renderer.label("",i.plotWidth-30,f).css({color:"black",fontSize:r}).attr({r:5,zIndex:6}).add())});console.timeEnd("Highcharts.stockChart");this.addPoints(this.options.data,!1);this.stockChart.redraw();this.stockChart.xAxis[0].setExtremes(this.stockChart.xAxis[0].max-this.options.duration*6e4,this.stockChart.xAxis[0].max);(this.note_series.options.data==null||this.note_series.options.data.length<=0)&&this.stockChart.series[0].update({showInNavigator:!1},!0)}createOptions(){var t=$("#"+this.chartId).width(),h=t/this.options.duration,v=30,u=v,f=8*h,y=1*h,e=u+f+y,o=5*h,nt=1*h,p=this.options.showNavigator?58:0,n=16,s,g;t<1e3&&(n=13);t<800&&(n=11);t<600&&(n=9);t<400&&(n=7);t<300&&(n=5);s=v+f+y+o+nt+p;$("#"+this.chartId).css("height",s);var i="#ff8c40",r="#ffc7a2",it=s,rt=s,ut=s*(82/100)+30,w=25,b=t*28.58/100,k=t*57.15/100,d=t*85.72/100,tt=n+2+"px",c=30,l=210;let a=this;return g={chart:{events:{load:function(){a.note_series=this.series[0];a.series0=this.series[1];a.series1=this.series[2];a.series2=this.series[3];this.yAxis[0].update({tickPositions:[50,60,80,100,120,140,160,180,200]});this.yAxis[1].update({tickPositions:[50,60,80,100,120,140,160,180,200]});this.yAxis[2].update({tickPositions:[50,60,80,100,120,140,160,180,200]});this.yAxis[3].update({tickPositions:[50,60,80,100,120,140,160,180,200]});this.yAxis[4].update({tickPositions:[0,20,40,60,80,100]});this.yAxis[5].update({tickPositions:[0,20,40,60,80,100]});this.yAxis[6].update({tickPositions:[0,20,40,60,80,100]});this.yAxis[7].update({tickPositions:[0,20,40,60,80,100]})},click:n=>{onclickEvent(n)}},spacingRight:0,spacingLeft:0,spacingBottom:0,spacingTop:0,zooming:{type:"x",mouseWheel:!1}},credits:{enabled:!1},navigator:{height:p,outlineWidth:this.options.showNavigator?1:0,handles:{enabled:!1},xAxis:{labels:{enabled:this.options.showNavigator,style:{fontSize:n+"px"}}}},scrollbar:{enabled:this.options.showNavigator},title:{},subtitle:{text:`Suite: ${this.options.patient.roomNo} &nbsp;&nbsp; Name: ${this.options.patient.patientName.ellipsis(20)}  &nbsp;&nbsp;    MRN: ${this.options.patient.mrnNo}    &nbsp;&nbsp;    Age: ${this.options.patient.age}  &nbsp;&nbsp; POA: ${this.options.patient.poa} &nbsp;&nbsp; Admitted Duration: ${this.options.patient.admittedHours}  `,style:{fontSize:n+"px",textAlign:"center"},y:15,align:"center"},legend:{enabled:!1},plotOptions:{series:{showInNavigator:!0,clip:!0,crisp:!1,dataGrouping:{units:[["second",[1,4]],["minute",[1]],["hour",[1]],["day",[1]],["week",[1]],["month",[1]],["year",null]]}},line:{color:{linearGradient:{x1:0,y1:0,x2:0,y2:0},stops:[]},states:{hover:{enabled:!1}},stickyTracking:!1}},rangeSelector:{enabled:!1,floating:!0,y:this.options.duration,inputDateFormat:"%d/%m/%Y %I:%M %P",buttons:[],selected:1},exporting:{enabled:!0,menuItemDefinitions:{notes:{onclick:()=>{var n="/CTG/PartialAllNotes?id="+this.options.stripId,t=$("#modal-"+this.chartId).modal("show",{backdrop:"static",keyboard:!1});t.find(".modal-content").load(n)},text:"View all notes"},separator:{separator:!0},view_single:{text:"Single view",onclick:()=>viewSingle(this.options.stripId)},view_1:{text:"Multiview 1 in a row",onclick:()=>changeViewColumns(1)},view_2:{text:"Multiview 2 in a row",onclick:()=>changeViewColumns(2)},view_3:{text:"Multiview 3 in a row",onclick:()=>changeViewColumns(3)},view_4:{text:"Multiview 4 in a row",onclick:()=>changeViewColumns(4)},view_5:{text:"Multiview 5 in a row",onclick:()=>changeViewColumns(5)},print:{onclick:()=>printChart(this),text:"Print Chart"}},buttons:{contextButton:{menuItems:this.options.showColumnSizeOptions?["notes","print","separator","view_single","view_1","view_2","view_3","view_4","view_5"]:["notes","print"],y:1}}},series:[{type:"scatter",name:"Notes",keys:["x","y","notes"],showInNavigator:!0,navigatorOptions:{},xAxis:0,marker:{radius:8},tooltip:{},stickyTracking:!0,events:{click:n=>{var t,i;if(this.options.isAdmitted){let r=n.point.options.x;t=moment(r).format("DD/MM/YYYY LTS");$("#CreatedDt").val(moment(r).format("MM/DD/YYYY LTS"));$("#note_label").html(t);$("#notes_text_area").val("");$("#NoteID").val(n.point.options.notes);let u="";$.ajax({dataType:"json",url:"/ctg/getnotebyid?id="+n.point.options.notes,"async":!1,success:n=>{u=n.notes}});$("#notes_text_area").val(u);i=!1;$("#modal-container1").modal("show");$("#modal-container1").on("hidden.bs.modal",()=>{i&&($("#NoteID").val(""),syncNotes())})}}}},{id:"fhr1",type:"line",name:"FHR1",color:"black",xAxis:0,showInNavigator:!0,tooltip:{valueDecimals:2},lineWidth:1},{id:"fhr2",type:"line",name:"FHR2",color:"red",tooltip:{valueDecimals:2},xAxis:0,showInNavigator:!0,lineWidth:1},{id:"toco",type:"line",name:"TOCO",color:"black",yAxis:4,xAxis:1,lineWidth:1,showInNavigator:!0,tooltip:{valueDecimals:2}},],xAxis:[{type:"datetime",tickInterval:6e5,minorTickInterval:6e4,gridLineColor:i,minorGridLineColor:r,gridLineWidth:1,minorGridLineWidth:1,labels:{format:"&#129045; {value:%d/%m/%Y %I:%M %P}",step:1,style:{fontSize:n+"px"},align:"left",x:-3,y:n+h/3.5},top:u,height:f,left:0,ordinal:!1,range:this.options.duration*6e4,lineWidth:0,tickWidth:0,minPadding:0,maxPadding:0,zoomEnabled:!1,zIndex:10,events:{afterSetExtremes:()=>{}}},{type:"datetime",tickInterval:6e5,minorTickInterval:6e4,labels:{enabled:!1,style:{fontSize:n+"px"}},gridLineColor:i,minorGridLineColor:r,gridLineWidth:1,minorGridLineWidth:1,top:e,height:o,left:0,ordinal:!1,range:this.options.duration*6e4,lineWidth:0,tickWidth:0,linkedTo:0,minPadding:0,maxPadding:0,zoomEnabled:!1},],yAxis:[{title:{},labels:{formatter:n=>{if(n.value!="50")return n.value},align:"right",x:w,y:4,style:{fontSize:n+"px"}},tickAmount:50,top:u,height:f,min:c,max:l,showLastLabel:!0,endOnTick:!1,alignTicks:!1,opposite:!1,minorTickInterval:10,tickInterval:10,gridLineWidth:1,minorGridLineWidth:1,gridLineColor:i,minorGridLineColor:r},{title:{},labels:{y:4,x:b,formatter:n=>{if(n.value!="50")return n.value},style:{fontSize:n+"px"}},linkedTo:0,opposite:!1,top:u,height:f,min:c,max:l,showLastLabel:!0,endOnTick:!1,alignTicks:!1,minorTickInterval:20,gridLineWidth:0,minorGridLineWidth:0,gridLineColor:i,minorGridLineColor:r},{title:{},labels:{y:4,x:k,formatter:n=>{if(n.value!="50")return n.value},style:{fontSize:n+"px"}},linkedTo:0,opposite:!1,top:u,height:f,min:c,max:l,showLastLabel:!0,endOnTick:!1,alignTicks:!1,minorTickInterval:20,gridLineWidth:0,minorGridLineWidth:0,gridLineColor:i,minorGridLineColor:r},{title:{},labels:{y:4,x:d,formatter:n=>{if(n.value!="50")return n.value},style:{fontSize:n+"px"}},linkedTo:0,opposite:!1,top:u,height:f,min:c,max:l,showLastLabel:!0,endOnTick:!1,alignTicks:!1,minorTickInterval:20,gridLineWidth:0,minorGridLineWidth:0,gridLineColor:i,minorGridLineColor:r},{plotLines:[{value:210,width:1,color:"#ccd6eb",dashStyle:"Solid"},{value:60,width:1,color:"red",dashStyle:"Solid"}],plotBands:[{color:"#fbfca2",from:0,to:0},{color:"#fbfca2",from:0,to:0}],title:{},labels:{align:"right",x:w,y:4,style:{fontSize:n+"px"}},tickAmount:25,top:e,height:o,min:0,max:100,showLastLabel:!0,endOnTick:!1,alignTicks:!1,opposite:!1,minorTickInterval:10,gridLineWidth:1,minorGridLineWidth:0,gridLineColor:i,minorGridLineColor:r},{labels:{y:4,x:b,formatter:n=>{if(n.value!="50")return n.value},style:{fontSize:n+"px"}},linkedTo:4,opposite:!1,top:e,height:o,min:0,max:100,showLastLabel:!0,endOnTick:!1,alignTicks:!1,minorTickInterval:20,gridLineColor:i,minorGridLineColor:r,gridLineWidth:1,minorGridLineWidth:1},{title:{},labels:{y:4,x:k,formatter:n=>{if(n.value!="50")return n.value},style:{fontSize:n+"px"}},linkedTo:4,opposite:!1,top:e,height:o,min:0,max:100,showLastLabel:!0,endOnTick:!1,alignTicks:!1,minorTickInterval:20,gridLineColor:i,minorGridLineColor:r,gridLineWidth:1,minorGridLineWidth:1},{title:{},labels:{y:4,x:d,formatter:n=>{if(n.value!="50")return n.value},style:{fontSize:n+"px"}},linkedTo:4,opposite:!1,top:e,height:o,min:0,max:100,showLastLabel:!0,endOnTick:!1,alignTicks:!1,minorTickInterval:20,gridLineColor:i,minorGridLineColor:r,gridLineWidth:1,minorGridLineWidth:1}],time:{useUTC:!1}},{options:g,label_font_size:tt.toString(),tocotop:e,fhrtop:u,width:t,height:s}}}class ZipChart{get zipChartId(){return"zchart_"+this.options.stripId}constructor(n,t){this.charts=[];n.duration=n.duration||35;this.options=n;this.onChartsCreated=t;var i=new Date(n.createdDt),r=i.getTime();unzipBlob(n.buffer,n.length).then(n=>{var t=n.split("|"),i=t.map(n=>{var t=n.split(";"),i=t[0].split(",").map(n=>parseFloat(n)),r=t[1],u=parseInt(t[2]);return{raw:i,type:r,addedSeconds:u}});this.data=i.map(n=>({createdDt:r+n.addedSeconds*1e3,fhR1:n.raw[0],fhR2:n.raw[1],toco:n.raw[2],noteId:null}));this.createCharts()})}createCharts(){var t,i,n;for(console.time("zip.createCharts"),this.options.divideDuration=this.options.divideDuration||this.data.length/60,t=this.options.divideDuration*60,i=this.data.length/t,i=this.data.length%t?Math.floor(i)+1:i,n=0;n<i;n++)this.charts.push(new CTGChart(n,{data:this.data.slice(n*t,(n+1)*t),duration:this.options.duration,isAdmitted:this.options.isAdmitted,patient:this.options.patient,stripId:this.options.stripId,showColumnSizeOptions:this.options.showColumnSizeOptions,showNavigator:this.options.showNavigator,isLive:this.options.isLive,showLatestValuesLabel:this.options.showLatestValuesLabel}));this.onChartsCreated(this.charts);console.timeEnd("zip.createCharts")}};
